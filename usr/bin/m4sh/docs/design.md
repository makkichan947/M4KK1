# M4SH - M4KK1 Shell 设计文档

## 概述

M4SH是M4KK1操作系统的默认Shell程序，是一个功能强大、易于扩展的命令行解释器。它基于传统的Unix Shell设计理念，但针对M4KK1的独特架构进行了深度优化和创新。

## 核心特性

### 1. 高性能设计
- **纯汇编核心**: 关键路径使用汇编优化
- **内存高效**: 优化的内存使用模式
- **快速启动**: 毫秒级启动时间
- **智能缓存**: 命令历史和补全缓存

### 2. 丰富的内置命令
- **文件操作**: ls, cd, pwd, mkdir, rmdir, cp, mv, rm
- **文本处理**: cat, echo, grep, sed, awk, sort, uniq
- **进程管理**: ps, kill, jobs, fg, bg, wait
- **系统信息**: whoami, date, uptime, uname
- **网络工具**: ping, wget, curl, netstat
- **开发工具**: make, gcc, gdb, vim, emacs

### 3. 高级功能
- **管道和重定向**: 支持复杂的数据流处理
- **作业控制**: 前后台作业管理和切换
- **命令补全**: 智能路径和命令补全
- **历史记录**: 命令历史搜索和编辑
- **别名系统**: 灵活的命令别名管理
- **脚本支持**: 强大的脚本编程能力

### 4. 创新特性
- **模块化设计**: 可动态加载的功能模块
- **插件系统**: 用户自定义扩展
- **云集成**: 云服务命令集成
- **AI助手**: 内置AI命令助手

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    M4SH 主程序                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   词法分析   │ │   语法分析   │ │   执行引擎   │ │ 作业控制 │  │
│  │   Lexer    │ │  Parser    │ │  Executor  │ │  Jobs   │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │ 内置命令模块 │ │ 外部命令模块 │ │ 管道处理模块 │ │ 重定向模块 │  │
│  │ Builtins   │ │ External   │ │ Pipeline  │ │ Redirect │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │ 补全系统     │ │ 历史系统     │ │ 别名系统     │ │ 插件系统 │  │
│  │ Completion │ │ History    │ │ Aliases   │ │ Plugins  │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│                 系统调用接口 (Syscall Interface)            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   进程管理   │ │   文件系统   │ │   内存管理   │ │ 网络协议 │  │
│  │  Process   │ │   Filesys  │ │  Memory   │ │ Network  │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 命令分类

### 1. 文件和目录操作
- **ls**: 列出目录内容
- **cd**: 改变当前目录
- **pwd**: 显示当前目录
- **mkdir**: 创建目录
- **rmdir**: 删除目录
- **cp**: 复制文件和目录
- **mv**: 移动/重命名文件和目录
- **rm**: 删除文件和目录
- **find**: 查找文件
- **touch**: 创建或更新文件时间戳

### 2. 文本处理
- **cat**: 连接和显示文件
- **echo**: 显示文本
- **head**: 显示文件开头部分
- **tail**: 显示文件结尾部分
- **sort**: 排序文本行
- **uniq**: 去除重复行
- **wc**: 统计字数
- **cut**: 切割文本
- **paste**: 合并文本行

### 3. 进程管理
- **ps**: 显示进程状态
- **top**: 显示系统进程
- **kill**: 发送信号到进程
- **jobs**: 显示作业状态
- **fg**: 前台运行作业
- **bg**: 后台运行作业
- **wait**: 等待进程完成
- **nice**: 调整进程优先级

### 4. 系统信息
- **date**: 显示系统日期和时间
- **whoami**: 显示当前用户名
- **id**: 显示用户和组信息
- **uname**: 显示系统信息
- **uptime**: 显示系统运行时间
- **df**: 显示磁盘空间使用情况
- **du**: 显示目录空间使用情况
- **free**: 显示内存使用情况

### 5. 网络工具
- **ping**: 测试网络连通性
- **wget**: 下载文件
- **curl**: 传输数据
- **netstat**: 显示网络状态
- **ifconfig**: 配置网络接口
- **ssh**: 安全Shell客户端
- **scp**: 安全文件复制
- **ftp**: 文件传输协议客户端

### 6. 开发工具
- **make**: 项目构建工具
- **gcc**: C/C++编译器
- **gdb**: 调试器
- **vim**: 文本编辑器
- **emacs**: 扩展编辑器
- **git**: 版本控制系统
- **svn**: Subversion版本控制
- **hg**: Mercurial版本控制

## 内置命令实现

### 基础命令（汇编实现）
```nasm
; cd命令汇编实现
m4sh_cd:
    push ebp
    mov ebp, esp

    ; 获取参数
    mov eax, [ebp + 8]      ; argc
    mov ebx, [ebp + 12]     ; argv

    ; 检查参数数量
    cmp eax, 2
    jl .no_arg

    ; 获取目标目录
    mov esi, [ebx + 4]      ; argv[1]

    ; 调用系统调用改变目录
    mov eax, SYSCALL_CHDIR
    int 0x80

    ; 检查错误
    test eax, eax
    js .error

    ; 成功
    xor eax, eax
    jmp .done

.no_arg:
    ; 默认切换到家目录
    mov esi, home_dir
    mov eax, SYSCALL_CHDIR
    int 0x80

    test eax, eax
    js .error

    xor eax, eax
    jmp .done

.error:
    ; 显示错误信息
    mov eax, 1               ; 错误码

.done:
    pop ebp
    ret
```

### 高级命令（C实现）
```c
// ls命令C实现
int m4sh_ls(int argc, char *argv[]) {
    // 解析选项
    m4sh_ls_options_t options;
    parse_ls_options(argc, argv, &options);

    // 获取目录列表
    m4sh_dir_entry_t *entries;
    int count = get_directory_entries(options.path, &entries);

    // 排序条目
    sort_directory_entries(entries, count, options.sort);

    // 显示条目
    for (int i = 0; i < count; i++) {
        display_directory_entry(&entries[i], &options);
    }

    // 清理资源
    free_directory_entries(entries, count);

    return 0;
}
```

## 脚本支持

### 脚本语法
```bash
#!/usr/bin/m4sh

# 变量赋值
name="M4KK1"
version="0.1.0"

# 函数定义
hello() {
    echo "Hello, $name $version!"
}

# 条件语句
if [ "$1" = "world" ]; then
    hello
else
    echo "Usage: $0 world"
fi

# 循环语句
for file in *.c; do
    echo "Compiling $file..."
    langcc -o "${file%.c}" "$file"
done

# 管道和重定向
ps aux | grep m4sh | head -10 > processes.txt

# 后台作业
long_running_command &
echo "PID: $!"
```

### 高级脚本特性
- **数组支持**: `files=("file1" "file2" "file3")`
- **关联数组**: `declare -A config=(["host"]="localhost" ["port"]="8080")`
- **字符串操作**: `${string:0:10}`, `${string//old/new}`
- **数学运算**: `result=$((a + b * c))`
- **正则表达式**: `if [[ "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then`

## 交互特性

### 命令补全
- **路径补全**: 自动补全文件和目录路径
- **命令补全**: 补全命令名称和选项
- **历史补全**: 搜索历史命令进行补全
- **可编程补全**: 用户自定义补全规则

### 历史管理
- **命令历史**: 保存和搜索命令历史
- **历史编辑**: 在历史命令基础上编辑
- **历史持久化**: 跨会话保存历史记录
- **历史统计**: 显示常用命令统计

### 作业控制
- **前后台切换**: `fg`, `bg`命令
- **作业列表**: `jobs`命令显示作业状态
- **信号控制**: `kill`命令发送信号
- **进程组管理**: 管理进程组关系

## 开发计划

### 第一阶段：核心框架
- [ ] Shell主程序框架
- [ ] 基本的内置命令（cd, echo, exit）
- [ ] 简单的命令执行
- [ ] 基础的I/O重定向

### 第二阶段：基础命令
- [ ] 文件操作命令（ls, cp, mv, rm）
- [ ] 文本处理命令（cat, grep）
- [ ] 进程管理命令（ps, kill）
- [ ] 系统信息命令（date, whoami）

### 第三阶段：高级功能
- [ ] 管道和复杂重定向
- **作业控制系统
- **命令补全机制
- **历史管理系统

### 第四阶段：脚本支持
- **脚本解析引擎
- **控制结构实现
- **函数定义支持
- **变量扩展机制

### 第五阶段：高级特性
- **插件系统开发
- **网络命令集成
- **开发工具集成
- **AI助手集成

## 与传统Shell对比

| 特性 | M4SH | Bash | Zsh | Fish |
|------|------|------|-----|------|
| 启动速度 | ✅ | ❌ | ❌ | ⚠️ |
| 内存占用 | ✅ | ⚠️ | ❌ | ⚠️ |
| 内置命令 | ✅ | ✅ | ✅ | ✅ |
| 脚本兼容性 | ✅ | ✅ | ✅ | ⚠️ |
| 插件系统 | ✅ | ⚠️ | ✅ | ✅ |
| 补全系统 | ✅ | ⚠️ | ✅ | ✅ |
| 历史管理 | ✅ | ✅ | ✅ | ✅ |
| 作业控制 | ✅ | ✅ | ✅ | ✅ |
| 跨平台支持 | ✅ | ⚠️ | ⚠️ | ⚠️ |

## 使用场景

### 1. 系统管理
- 系统配置和维护
- 软件包管理操作
- 系统监控和诊断
- 自动化任务执行

### 2. 软件开发
- 代码编译和构建
- 版本控制操作
- 测试和调试
- 文档生成

### 3. 数据处理
- 日志分析和处理
- 数据转换和清洗
- 批量文件操作
- 文本挖掘和分析

### 4. 网络操作
- 远程系统管理
- 文件传输和同步
- 网络诊断和测试
- 服务监控和管理

## 结论

M4SH Shell通过创新的架构设计和丰富的功能特性，为M4KK1操作系统提供了强大而高效的命令行界面。其独特的汇编优化、高性能设计和模块化架构将重新定义Shell程序的可能性边界，为各种使用场景提供最佳的命令行体验。