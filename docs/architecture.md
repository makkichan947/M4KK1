# M4KK1 操作系统架构设计

## 概述

M4KK1是一个全新的操作系统，采用创新的架构设计，旨在提供高性能、安全性和可扩展性。本文档描述了M4KK1的核心架构设计。

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    用户空间 (User Space)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   m4sh     │ │   pkgmgr   │ │  copland   │ │ rubidium│  │
│  │   Shell    │ │  包管理器   │ │ 窗口服务器 │ │ 桌面环境 │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │    vi      │ │   vicode   │ │   ivfetch  │ │  f1le   │  │
│  │   编辑器   │ │   IDE      │ │ 系统信息   │ │ 文件管理│  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   ptdsk    │ │    mtop    │ │   ntmgr    │ │ ntctl   │  │
│  │ 分区工具   │ │ 系统监控   │ │ 网络管理器 │ │ 网络工具│  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│                 系统调用接口 (Syscall Interface)             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   y4ku     │ │     yfs     │ │   swap2    │ │ langcc  │  │
│  │   内核     │ │ 文件系统   │ │ 交换系统   │ │ 编译器  │  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
├─────────────────────────────────────────────────────────────┤
│              硬件抽象层 (Hardware Abstraction Layer)        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐  │
│  │   bootcamp │ │   设备驱动  │ │ 内存管理   │ │ 中断处理 │  │
│  │ 引导加载器  │ │   Drivers   │ │  Memory   │ │ Interrupts│  │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘  │
└─────────────────────────────────────────────────────────────┘
                                │
                        硬件 (Hardware)
```

## 核心组件详述

### 1. 引导加载程序 (Bootcamp)

**位置**: `/sys/boot/bootcamp`

**功能**:
- 多阶段引导加载
- 硬件检测和初始化
- 内核映像加载
- 内存映射建立

**特点**:
- 纯汇编编写，确保快速启动
- 支持多种文件系统引导
- 模块化设计，可扩展硬件支持

### 2. 内核 (Y4KU)

**位置**: `/sys/src/y4ku/`

**架构**:
```
y4ku/
├── boot/           # 内核引导代码
├── arch/           # 架构相关代码
├── core/           # 核心内核功能
├── drivers/        # 设备驱动程序
├── fs/            # 文件系统接口
├── mm/            # 内存管理
├── net/           # 网络协议栈
├── ipc/           # 进程间通信
└── include/       # 头文件
```

**版本分类**:
- **stable**: 稳定生产版本
- **hardcore**: 高度优化版本
- **devel**: 开发测试版本
- **lts**: 长期支持版本

**核心特性**:
- 微内核架构
- 创新的进程通信机制
- 高效的内存管理
- 模块化驱动系统

### 3. 文件系统 (YFS)

**位置**: `/sys/src/yfs/`

**特性**:
- 比Btrfs更强大的功能集合
- 内置压缩支持
- 分割快照功能
- 休眠支持
- 日志记录
- 高性能I/O调度

**结构**:
```
yfs/
├── core/          # 核心文件系统代码
├── tools/         # 文件系统工具
├── journal/       # 日志系统
├── compression/   # 压缩算法
└── snapshot/      # 快照功能
```

### 4. 交换系统 (Swap2)

**位置**: `/sys/src/swap2/`

**改进特性**:
- 压缩支持，节省磁盘空间
- 日志记录，提高可靠性
- 快照功能，支持系统回滚
- 智能页面调度算法

### 5. 编译器集合 (LangCC)

**位置**: `/usr/opt/langcc/`

**支持语言**:
- C/C++
- Objective-C
- 汇编
- Shell脚本
- 自定义语言支持

**特性**:
- 高度优化代码生成
- 交叉编译支持
- 链接时优化
- 静态分析集成

## 系统目录结构

```
/                           # 根目录
├─ bin/                     # 基础用户命令
├─ dev/                     # 设备文件
│  ├─ full/                 # 全设备接口
│  ├─ mnt/                  # 挂载点
│  └─ null/                 # 空设备
├─ etc/ → /obj/etc          # 配置文件（符号链接）
├─ lib/                     # 共享库
│  ├─ include/              # 头文件
│  ├─ sys32/                # 32位系统库
│  ├─ sys64/                # 64位系统库
│  ├─ syscall/              # 系统调用库
│  └─ thread/               # 线程库
├─ obj/                     # 对象和配置
│  └─ etc/                  # 系统配置
├─ opt/ → /usr/opt          # 可选软件包（符号链接）
├─ pkg/                     # 包管理系统
│  └─ pkgmgr/               # 包管理器数据
├─ sbin/                    # 系统管理命令
├─ sys/                     # 系统核心
│  ├─ boot/                 # 引导相关
│  ├─ src/                  # 内核源码
│  └─ srv/                  # 系统服务
├─ usr/                     # 用户程序
│  ├─ .config/              # 用户配置
│  │  ├─ pkgmgr/            # 包管理配置
│  │  └─ 用户1/             # 用户特定配置
│  ├─ denv/                 # 桌面环境
│  │  └─ rubidium/          # Rubidium配置
│  ├─ root/                 # 超级用户目录
│  ├─ opt/                  # 用户安装软件
│  └─ usrs/                 # 用户主目录
│     └─ 用户1/             # 用户个人文件
└─ proc/                    # 进程信息（运行时创建）
```

## 启动流程

1. **BIOS/UEFI启动**: 固件加载bootcamp
2. **Stage 1**: bootcamp第一阶段，硬件检测
3. **Stage 2**: 加载文件系统驱动，读取内核
4. **内核初始化**: y4ku内核启动，初始化核心系统
5. **设备探测**: 加载必要设备驱动
6. **根文件系统挂载**: 挂载YFS根文件系统
7. **初始化脚本**: 执行系统初始化脚本
8. **用户空间启动**: 启动copland窗口服务器和rubidium桌面

## 创新特性

### 1. 独特的进程通信
- 非传统Unix IPC机制
- 基于消息的异步通信
- 零拷贝优化

### 2. 模块化设计
- 微内核架构
- 可动态加载的系统组件
- 热插拔支持

### 3. 高级内存管理
- 智能页面调度
- 压缩内存支持
- 内存快照和回滚

### 4. 安全特性
- 基于能力的访问控制
- 沙箱机制
- 安全引导链

## 开发工具链

- **构建系统**: CMake
- **编译器**: LangCC
- **调试器**: 自定义调试工具
- **性能分析**: 内置性能监控

## 测试策略

- 单元测试：每个模块独立测试
- 集成测试：组件间交互测试
- 系统测试：完整系统功能测试
- 性能测试：基准测试和压力测试

---

*本文档描述了M4KK1操作系统的核心架构设计，随着开发进展可能会进行调整和完善。*