# YFS (Yet Another File System) 设计文档

## 概述

YFS是一个创新的文件系统，旨在超越现有的文件系统如Btrfs、NTFS等。它结合了现代文件系统的优秀特性，并引入了独特的创新功能。

## 核心特性

### 1. 高性能架构
- **零拷贝I/O**: 减少数据复制操作
- **异步元数据更新**: 非阻塞元数据操作
- **智能缓存策略**: 自适应缓存算法
- **向量化I/O**: 批量数据传输优化

### 2. 高级数据管理
- **内置压缩**: 支持多种压缩算法（LZ4、Zstd、LZMA）
- **重复数据删除**: 块级和文件级去重
- **快照技术**: 支持增量和完整快照
- **数据校验**: 端到端数据完整性验证

### 3. 创新功能
- **分割快照**: 可选择性快照文件系统部分
- **休眠支持**: 文件系统级休眠和唤醒
- **版本控制**: 自动文件版本管理
- **实时迁移**: 在线文件系统格式转换

### 4. 可靠性特性
- **原子操作**: 所有操作要么完全成功，要么完全失败
- **日志系统**: 写前日志（WAL）确保一致性
- **错误纠正**: 自动检测和修复数据损坏
- **冗余机制**: 多副本和纠删码支持

## 磁盘布局

```
┌─────────────────────────────────────────────────────────────┐
│                    Super Block (超级块)                     │ 64KB
├─────────────────────────────────────────────────────────────┤
│                 Block Group Table (块组表)                  │ 1MB
├─────────────────────────────────────────────────────────────┤
│                    Journal Area (日志区)                    │ 128MB
├─────────────────────────────────────────────────────────────┤
│               Data Block Groups (数据块组)                  │ 剩余空间
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Block Group 0                           │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │         Block Bitmap (块位图)                      │ │ │
│  │  │  ┌─────────────────────────────────────────────────┐ │ │ │
│  │  │  │       Inode Bitmap (索引节点位图)              │ │ │ │
│  │  │  │  ┌─────────────────────────────────────────────┐ │ │ │ │
│  │  │  │  │           Inode Table (索引节点表)           │ │ │ │ │
│  │  │  │  │  ┌───────────────────────────────────────────┐ │ │ │ │ │
│  │  │  │  │  │         Data Blocks (数据块)             │ │ │ │ │ │
│  │  │  │  │  └───────────────────────────────────────────┘ │ │ │ │ │
│  │  │  │  └─────────────────────────────────────────────┘ │ │ │ │ │
│  │  │  └─────────────────────────────────────────────────┘ │ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │ │
│  │  │         Block Group 1                           │ │ │ │
│  │  │              ...                                │ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 数据结构

### 超级块结构
```c
struct yfs_superblock {
    uint32_t magic;              // YFS魔数
    uint32_t version;            // 文件系统版本
    uint32_t block_size;         // 块大小
    uint64_t total_blocks;       // 总块数
    uint64_t free_blocks;        // 空闲块数
    uint64_t total_inodes;       // 总索引节点数
    uint64_t free_inodes;        // 空闲索引节点数
    uint64_t journal_blocks;     // 日志块数
    uint32_t compression_alg;    // 默认压缩算法
    uint32_t checksum_alg;       // 校验算法
    uint8_t  uuid[16];           // 文件系统UUID
    uint64_t creation_time;      // 创建时间
    uint64_t mount_time;         // 挂载时间
    uint32_t mount_count;        // 挂载计数
    uint32_t state_flags;        // 状态标志
    uint8_t  reserved[4080];     // 保留空间
    uint32_t checksum;           // 校验和
};
```

### 索引节点结构
```c
struct yfs_inode {
    uint32_t magic;              // 索引节点魔数
    uint32_t mode;               // 文件模式
    uint32_t uid;                // 用户ID
    uint32_t gid;                // 组ID
    uint64_t size;               // 文件大小
    uint64_t atime;              // 访问时间
    uint64_t mtime;              // 修改时间
    uint64_t ctime;              // 创建时间
    uint32_t block_count;        // 块计数
    uint32_t link_count;         // 链接计数
    uint32_t flags;              // 标志
    uint32_t compression;        // 压缩标志
    uint32_t checksum_alg;       // 校验算法
    uint32_t extent_count;       // 扩展计数
    yfs_extent extents[16];      // 扩展数组
    uint8_t  reserved[256];      // 保留空间
    uint32_t checksum;           // 校验和
};
```

### 扩展结构
```c
struct yfs_extent {
    uint64_t logical_block;      // 逻辑块号
    uint64_t physical_block;     // 物理块号
    uint32_t length;             // 长度（块）
    uint32_t flags;              // 标志
};
```

## 核心算法

### 1. 压缩算法支持
- **LZ4**: 快速压缩，适合实时场景
- **Zstd**: 高压缩率，平衡性能
- **LZMA**: 最大压缩率，适合归档

### 2. 校验算法
- **CRC32C**: 快速校验
- **SHA256**: 强加密校验
- **BLAKE3**: 高性能加密校验

### 3. 分配策略
- **块分配**: 基于热度的智能分配
- **索引节点分配**: 目录局部性优化
- **碎片整理**: 在线碎片整理和优化

## 高级功能实现

### 分割快照
分割快照允许用户选择性地对文件系统的特定部分创建快照：

```c
int yfs_create_partial_snapshot(const char *path, uint32_t flags);
int yfs_restore_partial_snapshot(const char *snapshot_path, const char *target_path);
```

### 休眠支持
文件系统级休眠允许整个文件系统进入休眠状态：

```c
int yfs_enter_hibernate(const char *device);
int yfs_exit_hibernate(const char *device);
```

### 版本控制
自动版本控制跟踪文件的历史变更：

```c
int yfs_enable_versioning(const char *path, uint32_t max_versions);
yfs_version_t *yfs_list_versions(const char *path);
int yfs_restore_version(const char *path, yfs_version_t version);
```

## 性能优化

### 1. 缓存层设计
- **页面缓存**: 改进的LRU算法
- **元数据缓存**: B+树结构的元数据缓存
- **压缩缓存**: 预压缩和解压缩缓存

### 2. I/O优化
- **异步I/O**: 基于AIO的异步操作
- **零拷贝**: 减少内存复制
- **批量操作**: 向量化I/O操作

### 3. 并行处理
- **多线程分配**: 并行块分配和释放
- **锁优化**: 细粒度锁定机制
- **无锁算法**: 在热点路径使用无锁数据结构

## 可靠性保证

### 1. 原子性保证
所有操作都是原子性的，使用写前日志（WAL）确保一致性。

### 2. 错误检测和恢复
- **校验和验证**: 所有数据的完整性检查
- **坏块管理**: 自动检测和隔离坏块
- **恢复机制**: 自动错误恢复和修复

### 3. 数据保护
- **多副本**: 可配置的冗余级别
- **纠删码**: Reed-Solomon纠删码支持
- **快照保护**: 快照数据的保护机制

## 开发计划

### 第一阶段：基础框架
- [ ] 超级块和基本数据结构
- [ ] 块和索引节点管理
- [ ] 基础读写操作
- [ ] 日志系统

### 第二阶段：核心功能
- [ ] 目录操作
- [ ] 文件操作
- [ ] 权限管理
- [ ] 扩展属性

### 第三阶段：高级特性
- [ ] 压缩支持
- [ ] 快照功能
- [ ] 休眠支持
- [ ] 版本控制

### 第四阶段：优化和测试
- [ ] 性能优化
- [ ] 可靠性测试
- [ ] 与现有系统的互操作性
- [ ] 文档完善

## 与现有文件系统的对比

| 特性 | YFS | Btrfs | NTFS | ext4 |
|------|-----|-------|------|------|
| 压缩 | ✅ | ✅ | ❌ | ❌ |
| 快照 | ✅ | ✅ | ✅ | ❌ |
| 分割快照 | ✅ | ❌ | ❌ | ❌ |
| 休眠支持 | ✅ | ❌ | ❌ | ❌ |
| 版本控制 | ✅ | ❌ | ❌ | ❌ |
| 在线碎片整理 | ✅ | ✅ | ❌ | ❌ |
| 重复数据删除 | ✅ | ✅ | ❌ | ❌ |
| 内置校验 | ✅ | ✅ | ✅ | ❌ |

## 结论

YFS文件系统旨在成为下一代文件系统的典范，通过创新的架构和丰富的功能，为用户提供前所未有的文件管理体验。其独特的分隔快照、休眠支持和版本控制功能将重新定义文件系统的可能性边界。