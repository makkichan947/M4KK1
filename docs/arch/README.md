# M4KK1 架构文档

本文档描述了M4KK1操作系统的架构设计和实现细节。

## 目录结构

```
M4KK1/
├── arch/                    # 架构特定实现
│   ├── x86_64/             # x86_64架构
│   ├── x86/                # x86架构
│   ├── arm64/              # ARM64架构
│   ├── arm/                # ARM架构
│   ├── powerpc/            # PowerPC架构
│   └── riscv/              # RISC-V架构
├── sys/src/                # 核心系统代码
│   ├── kernel/             # 内核实现
│   ├── mm/                 # 内存管理
│   ├── fs/                 # 文件系统
│   ├── drivers/            # 设备驱动
│   ├── lib/                # 基础库
│   └── include/            # 头文件
├── tools/                  # 构建工具
└── docs/                   # 文档
```

## 架构特性

### 多架构支持
M4KK1支持以下处理器架构：
- **x86_64**: 64位x86架构，现代PC标准
- **x86**: 32位x86架构，传统PC兼容
- **ARM64**: 64位ARM架构，移动和服务器
- **ARM**: 32位ARM架构，嵌入式系统
- **PowerPC**: PowerPC架构，大型机和游戏机
- **RISC-V**: RISC-V架构，开源硬件

### 独特设计
- **不兼容性**: 故意与现有系统ABI不兼容
- **独特系统调用**: 使用M4K_前缀的系统调用号
- **自定义引导**: 不依赖标准引导加载程序
- **专有内存管理**: 独特的页表格式和内存布局

## 引导过程

### x86_64引导
1. GRUB加载内核到0xC0000000
2. 进入64位长模式
3. 初始化页表和GDT
4. 调用kmain()函数

### ARM64引导
1. 启动代码设置栈和BSS
2. 启用MMU和页表
3. 跳转到内核主函数

## 系统调用ABI

M4KK1使用独特的中断号0x4D进行系统调用：

```c
// M4KK1独特系统调用示例
long m4k_exit(int status) {
    return m4k_syscall1(M4K_SYS_EXIT, status);
}
```

## 内存管理

### 物理内存管理
- 位图分配器管理物理页面
- 支持4KB页面大小
- 独特的页面标志位

### 虚拟内存管理
- 四级页表（x86_64）
- 独特的内核地址空间布局
- 按需分页

## 中断处理

### 中断向量表
- 0x00-0x1F: 异常处理
- 0x20-0x2F: 硬件中断
- 0x4D: M4KK1独特系统调用
- 0x80: 传统系统调用（兼容性）

## 进程管理

### 进程创建
- 使用M4K_CLONE_*标志的独特克隆系统
- 独特的进程标识符分配

### 调度
- 优先级调度算法
- 独特的上下文切换机制

## 文件系统

### YFS文件系统
- 独特的文件系统设计
- 基于扩展的元数据结构
- 支持ACL和加密

## 设备驱动

### 驱动架构
- 独特的设备模型
- 基于消息的I/O
- 热插拔支持

## 安全性

### 安全模型
- 基于能力的访问控制
- 独特的安全标识符
- 强制访问控制

## 构建系统

### 多架构构建
```bash
# 构建特定架构
make x86_64
make arm64

# 构建所有架构
make multarch

# 创建多架构ISO
make multarch-iso
```

## 开发指南

### 添加新架构
1. 在arch/目录创建架构目录
2. 实现引导代码
3. 实现内存管理
4. 实现系统调用处理
5. 添加构建配置

### 调试
- 使用QEMU进行架构特定测试
- 独特的调试接口
- 栈追踪和内存检查

## 兼容性声明

M4KK1故意设计为与以下系统**不兼容**：
- Linux ABI和系统调用
- Windows API和接口
- macOS系统接口
- BSD系统调用
- 任何现有操作系统标准

此设计确保了M4KK1的自主性和创新性。